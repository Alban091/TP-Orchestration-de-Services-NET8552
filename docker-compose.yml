version: '3.8'

# ═══════════════════════════════════════════════════════════════════════════════
# TP NET8552 - Chaîne de Services Réseau
# Architecture: Firewall → Load Balancer → Web Server
# Optimisé pour Apple Silicon (ARM64)
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # VNF 3: Web Server (Backend)
  # ─────────────────────────────────────────────────────────────────────────────
  webserver:
    image: nginx:alpine
    container_name: vnf-web
    hostname: vnf-web
    ports:
      - "8081:80"
    networks:
      - vnf-network
    volumes:
      - ./configs/webserver/index.html:/usr/share/nginx/html/index.html:ro
      - ./configs/webserver/style.css:/usr/share/nginx/html/style.css:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      - "net8552.role=webserver"
      - "net8552.layer=backend"

  # ─────────────────────────────────────────────────────────────────────────────
  # VNF 2: Load Balancer (Middle Layer)
  # ─────────────────────────────────────────────────────────────────────────────
  loadbalancer:
    image: haproxytech/haproxy-alpine:latest
    container_name: vnf-lb
    hostname: vnf-lb
    ports:
      - "9090:80"
      - "8404:8404"  # Stats page
    networks:
      - vnf-network
    volumes:
      - ./configs/loadbalancer/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      webserver:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      - "net8552.role=loadbalancer"
      - "net8552.layer=middle"

  # ─────────────────────────────────────────────────────────────────────────────
  # VNF 1: Firewall (Frontend/Entry Point)
  # ─────────────────────────────────────────────────────────────────────────────
  firewall:
    image: nginx:alpine
    container_name: vnf-firewall
    hostname: vnf-firewall
    ports:
      - "8080:80"
    networks:
      - vnf-network
    volumes:
      - ./configs/firewall/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - loadbalancer
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      - "net8552.role=firewall"
      - "net8552.layer=frontend"

# ─────────────────────────────────────────────────────────────────────────────
# Réseau Bridge pour la chaîne VNF
# ─────────────────────────────────────────────────────────────────────────────
networks:
  vnf-network:
    driver: bridge
    name: net8552-chain
    ipam:
      config:
        - subnet: 172.28.0.0/16
