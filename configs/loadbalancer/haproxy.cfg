# ═══════════════════════════════════════════════════════════════════════════════
# HAProxy Configuration - Load Balancer VNF
# NET8552 - Télécom SudParis
# ═══════════════════════════════════════════════════════════════════════════════

global
    log stdout format raw local0
    maxconn 4096
    stats socket /var/run/haproxy.sock mode 660 level admin

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    
    # Custom log format
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r [LB]"

# ─────────────────────────────────────────────────────────────────────────────
# Stats Dashboard (accessible on :8404)
# ─────────────────────────────────────────────────────────────────────────────
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats show-legends
    stats show-node

# ─────────────────────────────────────────────────────────────────────────────
# Main HTTP Frontend
# ─────────────────────────────────────────────────────────────────────────────
frontend http_front
    bind *:80
    
    # Add headers for tracing
    http-request set-header X-Load-Balancer "vnf-lb"
    http-request set-header X-Request-Start "%t"
    
    default_backend http_back

# ─────────────────────────────────────────────────────────────────────────────
# Backend Pool - Web Servers
# ─────────────────────────────────────────────────────────────────────────────
backend http_back
    balance roundrobin
    option httpchk GET /
    
    # Response header to identify the backend
    http-response set-header X-Backend-Server %s
    
    # Web server pool (single instance for this TP)
    server webserver vnf-web:80 check inter 5s fall 3 rise 2
